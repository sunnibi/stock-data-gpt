name: Fetch Stock Data Manually

on:
  workflow_dispatch:
    inputs:
      ticker:
        description: "Stock ticker (e.g. TSLA, 005930). For KRX, provide code without .KS/.KQ suffix"
        required: true
      market:
        description: "Market"
        required: true
        type: choice # ì‚¬ìš©ìê°€ UIì—ì„œ US ë˜ëŠ” KRë§Œ ì„ íƒ ê°€ëŠ¥
        options:
          - US
          - KR
        default: "US"
      num_days:
        description: "Number of days for historical data if no prior data exists (e.g., 60)"
        required: false # í•„ìˆ˜ê°€ ì•„ë‹ˆë©°, ì…ë ¥í•˜ì§€ ì•Šìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©
        default: "60" # ê¸°ë³¸ ì¡°íšŒ ê¸°ê°„ 60ì¼

jobs:
  fetch_and_commit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11' # ë˜ëŠ” ì„ í˜¸í•˜ëŠ” Python ë²„ì „ (ì˜ˆ: '3.9', '3.10')

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then 
            pip install -r requirements.txt
          else
            echo "requirements.txt not found. Please ensure yfinance is installed if not listed."
            # ë¹„ìƒì‹œ ì§ì ‘ ì„¤ì¹˜ (requirements.txt ì‚¬ìš© ê¶Œì¥)
            # pip install yfinance 
          fi

      - name: Run get_stock_data.py with inputs
        run: |
          echo "Running script for ticker: ${{ github.event.inputs.ticker }}, market: ${{ github.event.inputs.market }}, days: ${{ github.event.inputs.num_days }}"
          python get_stock_data.py "${{ github.event.inputs.ticker }}" "${{ github.event.inputs.market }}" "${{ github.event.inputs.num_days }}"

      - name: Commit and Push data
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # ì›Œí¬í”Œë¡œìš°ê°€ ì‹¤í–‰ëœ ë¸Œëœì¹˜(ë³´í†µ main)ì˜ ìµœì‹  ë³€ê²½ì‚¬í•­ì„ ê°€ì ¸ì™€ì„œ rebase
          # ì´ë ‡ê²Œ í•˜ë©´ ë‹¤ë¥¸ ê³³ì—ì„œ mainì— ë³€ê²½ì‚¬í•­ì´ ìˆì—ˆì„ ê²½ìš°, ê·¸ ìœ„ì— í˜„ì¬ ë³€ê²½ì‚¬í•­ì„ ìŒ“ê²Œ ë©ë‹ˆë‹¤.
          git pull origin ${{ github.ref_name }} --rebase 
          
          git add data/**/*.json # data í´ë” ë‚´ì˜ ëª¨ë“  json íŒŒì¼ ì¶”ê°€
          
          # ìŠ¤í…Œì´ì§•ëœ ë³€ê²½ì‚¬í•­ì´ ìˆì„ ë•Œë§Œ ì»¤ë°‹ ë° í‘¸ì‹œ
          if git diff --staged --quiet; then
            echo "No new data or changes to commit."
          else
            git commit -m "ğŸ“ˆ Update stock data for ${{ github.event.inputs.ticker }} (${{ github.event.inputs.market }})"
            # í˜„ì¬ ì›Œí¬í”Œë¡œìš°ê°€ ì‹¤í–‰ëœ ë¸Œëœì¹˜ë¡œ í‘¸ì‹œ
            git push origin ${{ github.ref_name }}
            echo "Changes committed and pushed."
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # GitHub Actionsê°€ ìë™ìœ¼ë¡œ ìƒì„±í•˜ëŠ” í† í°
          TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
          LOG_FILE="logs/${{ github.event.inputs.ticker }}_${TIMESTAMP}.log"
          echo "Running script for ticker=${{ github.event.inputs.ticker }} market=${{ github.event.inputs.market }}" | tee $LOG_FILE
          python get_stock_data.py ${{ github.event.inputs.ticker }} ${{ github.event.inputs.market }} | tee -a $LOG_FILE
